{% extends 'base.html' %}
{% load static %}
{% load pricing %}
{% load humanize %}

{% block robots %}
    <meta name="robots" content="noindex, nofollow">
{% endblock %}

{% block title %}Количка – iBands{% endblock %}

{% block meta_description %}
    Прегледайте вашата количка в iBands и преминете към поръчка. Всички добавени продукти, количества и суми на едно място.
{% endblock %}

{% block content %}
    {% include 'partials/_breadcrumbs.html' %}

    <section class="middle">
        <div class="container">
            <form action="{% url 'store:create_order' %}" method="POST">
                {% csrf_token %}
                <div class="row">
                    <div class="col-lg-9">
                        <h4 class="fw-bold p-3">Продукти в количката</h4>
                        <div style="overflow-y: scroll; max-height: 650px; overflow-x: hidden" class="p-3">
                            {% for item in items %}
                                <div class="shadow rounded mb-3 item_div_{{ item.id }}">
                                    <div class="row d-flex align-items-center text-center p-3">
                                        {% include 'store/_product_card.html' with item=item %}
                                        <div class="col-xl-2 mb-xl-3">
                                            {% if item.product.sale_price and item.product.sale_price < item.product.price %}
                                                <span class="text-decoration-line-through">{% regular_plus_delta item.product item.size item.model as reg_plus %}{{ reg_plus|dual_price }}</span>
                                            {% else %}
                                                <span class="invisible d-none d-xl-inline">{{ 0|dual_price }}</span>
                                            {% endif %}
                                            <h4 id="item-price-{{ item.id }}" class="fs-3 {% if item.product.sale_price and item.product.sale_price < item.product.price %}fw-bold text-danger{% else %}text-dark{% endif %}" data-unit-price="{{ item.price|floatformat:2 }}">
                                                {% if item.product.has_active_promo and item.promo_free_units >= item.qty %}
                                                    {{ 0|dual_price }}
                                                {% else %}
                                                    {{ item.price|dual_price }}
                                                {% endif %}
                                            </h4>
                                            <div id="promo-free-{{ item.id }}" class="small text-success {% if not item.product.has_active_promo or item.promo_free_units <= 0 %}d-none{% endif %}">
                                                {% if item.product.has_active_promo and item.promo_free_units > 0 %}+{{ item.promo_free_units }} бр. безплатно{% endif %}
                                            </div>
                                        </div>
                                        <div class="col-xl-2 offset-xl-0 col-6 offset-3 d-flex justify-content-center">
                                            <button type="button" class="btn btn-primary btn-xs update_cart_qty" data-update_type="decrease" data-item_id="{{ item.id }}"><i class="fas fa-minus fa-xs"></i></button>
                                            <input type="number" readonly class="form-control form-sm item-qty-{{ item.id }} text-center px-1" value="{{ item.qty }}" name="" id="" />
                                            <button type="button" class="btn btn-primary btn-xs update_cart_qty" data-update_type="increase" data-item_id="{{ item.id }}"><i class="fas fa-plus fa-xs"></i></button>
                                        </div>
                                        <div class="col-xl-2 mb-xl-3">
                                            <span class="invisible d-none d-xl-block">{{ 0|dual_price }}</span>
                                            <h4 class="fs-3"><span class="item_sub_total_{{ item.id }}">{{ item.sub_total|dual_price }}</span></h4>
                                        </div>
                                        <div class="col-xl-1">
                                            <button type="button" class="btn btn-danger btn-sm rounded delete_cart_item" data-item_id="{{ item.id }}" data-product_id="{{ item.product.id }}"><i class="fas fa-trash"></i></button>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="col-lg-3">
                        <h4 class="fw-bold">Обобщение на поръчката</h4>
                        <div class="shadow rounded p-3 mt-5">
                            <div class="d-flex justify-content-between align-items-center">
                                <p class="fw-medium text-dark fs-6 mb-0">Доставката и купоните се начисляват на следващата стъпка</p>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mt-3">
                                <p class="fw-bold fs-5">Общо</p>
                                <p class="fw-bold fs-5">
                                    <span class="cart_sub_total">{{ cart_sub_total|dual_price }}</span>
                                </p>
                                <span id="cart-order-subtotal" data-value="{{ cart_sub_total|floatformat:2 }}" class="d-none"></span>
                            </div>
                        </div>
                        <div class="mt-3 p-3 rounded shadow border free-ship-widget" role="region" aria-label="Прогрес до безплатна доставка">
                            <div class="d-flex align-items-center justify-content-between mb-2">
                                <div class="text-dark fw-semibold free-ship-title">
                                    <i class="fas fa-shipping-fast me-1"></i>
                                    <span id="free-ship-text">Изчисляване...</span>
                                </div>
                                
                            </div>
                            <div class="progress free-ship-progress">
                                <div id="free-ship-bar" class="progress-bar bg-success" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                        </div>

                        <div class="d-flex justify-content-center w-100 mt-3">
                            {% if request.user.is_authenticated %}
                                <button type="submit" class="btn btn-primary rounded w-100">Продължи към поръчка <i class="fas fa-arrow-right ms-1"></i></button>
                            {% else %}
                                <div class="d-grid gap-2">
                                    <a href="{% url 'userauths:sign-in' %}?next={{ request.path }}" class="btn btn-outline-primary rounded w-100 mb-2">Влез</a>
                                    <a href="{% url 'userauths:sign-up' %}?next={{ request.path }}" class="btn btn-outline-secondary rounded w-100 mb-2">Създай профил</a>
                                    <small class="text-muted text-center mt-2">Регистрирай се, за да следиш поръчките си, да пазаруваш по-бързо и да получаваш ексклузивни намаления!</small>
                                    <button type="submit" class="btn btn-primary rounded w-100">Поръчай като гост</button>
                                    <small class="text-muted text-center mt-2">Поръчката като гост не изисква регистрация.</small>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </section>
{% endblock %}

{% block extra_scripts %}
<script src="{% static 'assets/js/free_shipping.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    try { if (window.FreeShippingWidget) window.FreeShippingWidget.update(75) } catch(e) {}
});
</script>
{% endblock %}
