{% extends 'base.html' %}
{% load humanize %}

{% block robots %}
    <meta name="robots" content="noindex, nofollow">
{% endblock %}

{% block title %}
    Завършване на поръчка – iBands
{% endblock %}

{% block meta_description %}
    Попълнете вашите данни и финализирайте поръчката си в iBands. Сигурно пазаруване и бърза доставка.
{% endblock %}

{% block content %}
    <style>
    .collapsible-section {
        overflow: hidden;
        transition: max-height 0.4s cubic-bezier(0.4,0,0.2,1);
        max-height: 0;
        will-change: max-height;
    }
    .collapsible-section.open {
        max-height: 2000px;
    }
    @media (min-width: 992px) {
        .sticky-order-summary {
            position: sticky;
            top: 80px;
            z-index: 10;
        }
    }
    </style>
    {% include 'partials/_breadcrumbs.html' %}

    <section class="middle">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-xl-12 col-lg-12 col-md-12 col-sm-12">
                    <div class="sec_title position-relative text-center">
                        <h3 class="fw-semibold pt-3">Завършване на поръчка</h3>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-lg-9">
                    <h4 class="fw-bold p-3">Продукти</h4>
                    <div id="order-items-block">
                        {% include "store/_checkout_items.html" %}
                    </div>

                    <div class="p-3">
                        <div class="shadow rounded p-3">
                            <h4 class="fw-bold mb-3">Начин на плащане</h4>
                            <div id="payment-error-block"></div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="radio" name="payment_method" id="payment-card" value="card">
                                <label class="form-check-label" for="payment-card">Плащане с карта</label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="radio" name="payment_method" id="payment-cod" value="cash_on_delivery">
                                <label class="form-check-label" for="payment-cod">Наложен платеж</label>
                            </div>
                        </div>

                        <!-- Shipping Method Card -->
                        <div class="card-wrap shadow rounded mb-4 mt-4">
                            <div class="card-wrap-header px-3 py-2 border-bottom d-flex align-items-center justify-content-between">
                                <div class="card-header-flex">
                                    <h4 class="fs-md fw-semibold mb-3">Метод на доставка</h4>
                                </div>
                            </div>
                            <div class="card-wrap-body px-3 py-3">
                                <div id="shipping-error-block"></div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="radio" name="shipping_method" id="shipping-econt" value="econt">
                                    <label class="form-check-label" for="shipping-econt">
                                        Econt (до офис/адрес)
                                    </label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="radio" name="shipping_method" id="shipping-speedy" value="speedy">
                                    <label class="form-check-label" for="shipping-speedy">
                                        Speedy (до офис/адрес)
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col">
                            <div id="econt-shipping-block" class="collapsible-section">
                                <div class="card-wrap rounded mb-4">
                                    <div class="card-wrap-header px-3 py-2 border-bottom d-flex align-items-center justify-content-between">
                                        <div class="card-header-flex">
                                            <h4 class="fs-md fw-semibold mb-1">Еконт доставка</h4>
                                        </div>
                                    </div>
                                    <div class="card-wrap-body px-3 py-3">
                                        <div class="mb-2">
                                            <div class="alert alert-info">
                                                Моля, попълнете вашите данни за доставка чрез формата на Еконт по-долу. След като попълните и потвърдите, ще използваме тази информация за изпращане на вашата поръчка.
                                            </div>
                                        </div>
                                        <div id="econt-error-block"></div>
                                        <iframe
                                            id="econt-delivery-iframe"
                                            src="{{ econt_url }}"
                                            width="100%"
                                            height="750"
                                            frameborder="0"
                                            allowfullscreen
                                        ></iframe>
                                        <input type="hidden" id="econt_customer_name" name="econt_customer_name">
                                        <input type="hidden" id="econt_customer_phone" name="econt_customer_phone">
                                        <input type="hidden" id="econt_customer_email" name="econt_customer_email">
                                        <input type="hidden" id="econt_customer_city" name="econt_customer_city">
                                        <input type="hidden" id="econt_customer_address" name="econt_customer_address">
                                        <input type="hidden" id="econt_customer_office_name" name="econt_customer_office_name">
                                        <input type="hidden" id="econt_customer_office_code" name="econt_customer_office_code">
                                        <input type="hidden" id="econt_customer_face" name="econt_customer_face">
                                        <input type="hidden" id="econt_customer_post_code" name="econt_customer_post_code">
                                        <div id="shipping-price-block" class="mt-2"></div>
                                    </div>
                                </div>
                            </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3">
                    <div class="sticky-order-summary">
                    <h4 class="fw-bold">Обобщение на поръчката</h4>
                    <div id="order-summary-block">
                        {% include "store/_checkout_summary.html" %}
                    </div>

                    <div class="shadow rounded p-3 mt-3">
                        <h4 class="fw-bold">Купони</h4>
                        <form id="coupon-form" class="mb-3 d-flex" action="{% url 'store:coupon_apply' order.order_id %}" method="POST">
                            {% csrf_token %}
                            <input type="text" class="form-control" name="coupon_code" placeholder="Код за отстъпка" />
                            <button type="submit" class="btn btn-success"><i class="fas fa-check-circle"></i></button>
                        </form>
                        <div id="coupon-feedback"></div>
                    </div>
                    
                    <div class="p-3 mt-3">
                        <div id="checkout-error-block"></div>
                        <button type="button" id="continue-payment" class="btn btn-primary w-100">Завърши поръчка</button>
                        <button id="stripe-payment" style="display:none;" type="button"></button>
                        <button id="cod-payment" style="display:none;" type="button"></button>
                    </div>

                    <div class="alert alert-success text-dark text-center mt-3 mb-4" role="alert" style="font-size: 1.1rem;">
                        <i class="fas fa-shipping-fast"></i>
                        <b>Безплатна доставка</b> до офис или автомат на <b>Спиди</b> и <b>Еконт</b> за поръчки над <b>75 лв.</b>!
                    </div>
                    <div class="alert alert-info text-dark text-center mb-4" role="alert" style="font-size: 1.1rem;">
                        <i class="fas fa-credit-card"></i>
                        <b>50% отстъпка от доставката</b> при плащане с карта!
                        Платете с карта онлайн и получете 50% намаление на цената за доставка до офис или адрес на <b>Спиди</b> и <b>Еконт</b>.
                    </div>
                </div>
            </div>
        </div>
    </section>

{% endblock %}

{% block extra_scripts %}
<script src="https://js.stripe.com/v3/"></script>
<script>
    // Stripe payment logic (address must be saved before payment)
    var stripe = Stripe('{{stripe_public_key}}');
    var checkoutButton = document.getElementById('stripe-payment');

    // Unified Econt payment handler
    function handleEcontPayment(button, paymentType) {
        var officeName = document.getElementById('econt_customer_office_name')?.value;

        var addressData = {
            name: document.getElementById('econt_customer_name').value,
            phone: document.getElementById('econt_customer_phone').value,
            email: document.getElementById('econt_customer_email').value,
            delivery_method: officeName ? 'econt_office' : 'econt',
            city: document.getElementById('econt_customer_city').value,
            address: document.getElementById('econt_customer_address').value,
            office_code: document.getElementById('econt_customer_office_code')?.value,
            office_name: officeName,
            face: document.getElementById('econt_customer_face').value,
            post_code: document.getElementById('econt_customer_post_code').value,
            shipping_price: (selectedPayment === 'card')
                ? (lastEcontShipping.shipping_price_cod ? (parseFloat(lastEcontShipping.shipping_price_cod) * 0.5).toFixed(2) : null)
                : lastEcontShipping.shipping_price_cod
        };

        var econtErrorBlock = document.getElementById('econt-error-block');
        if (econtErrorBlock) econtErrorBlock.innerHTML = '';

        if (!addressData.phone || (!addressData.office_name && !addressData.address)) {
            if (econtErrorBlock) {
                econtErrorBlock.innerHTML = '<div class="alert alert-danger mb-2">Моля, попълнете и потвърдете адреса за доставка чрез формата на Еконт!</div>';
                econtErrorBlock.scrollIntoView({ behavior: "smooth", block: "center" });
            }
            return;
        }

        if (paymentType === 'card') {
            button.innerHTML = 'Плащане с карта <i class="fas fa-spinner fa-spin ms-2"></i>';
        } else {
            button.innerHTML = 'Наложен платеж <i class="fas fa-spinner fa-spin"></i>';
        }

        fetch('/save-econt-address/{{ order.order_id }}/', {
            method: 'POST',
            headers: { 'X-CSRFToken': csrftoken, 'Content-Type': 'application/json' },
            body: JSON.stringify(addressData)
        })
        .then(function (resp) { return resp.json(); })
        .then(function (respData) {
            if (respData.success) {
                if (paymentType === 'card') {
                    // Stripe payment
                    fetch('/stripe-payment/{{order.order_id}}/', {
                        method: 'POST',
                        body: JSON.stringify({ email: addressData.email })
                    })
                    .then(function (response) { return response.json() })
                    .then(function (session) {
                        return stripe.redirectToCheckout({ sessionId: session.sessionId })
                    })
                    .then(function (result) {
                        if (result.error) {
                            if (window.Toast) {
                                window.Toast.fire({ icon: "error", title: result.error.message });
                            } else {
                                alert(result.error.message);
                            }
                        }
                    })
                    .catch(function (error) {
                        console.log('Error: ', error)
                    });
                } else if (paymentType === 'cash_on_delivery') {
                    // COD payment
                    fetch("{% url 'store:cod_payment' order.order_id %}", {
                        method: 'POST',
                        headers: { 'X-CSRFToken': csrftoken }
                    })
                    .then(function (response) {
                        if (response.redirected) {
                            window.location.href = response.url;
                        }
                    });
                }
            } else {
                if (econtErrorBlock) {
                    econtErrorBlock.innerHTML = '<div class="alert alert-danger mb-2">Възникна неочаквана грешка при запазване на адреса. Моля, опитайте отново.</div>';
                    econtErrorBlock.scrollIntoView({ behavior: "smooth", block: "center" });
                }
                button.innerHTML = (paymentType === 'card') ? 'Плащане с карта' : 'Наложен платеж';
            }
        })
        .catch(function (error) {
            if (econtErrorBlock) {
                econtErrorBlock.innerHTML = '<div class="alert alert-danger mb-2">Възникна неочаквана грешка при запазване на адреса. Моля, опитайте отново.</div>';
                econtErrorBlock.scrollIntoView({ behavior: "smooth", block: "center" });
            }
            button.innerHTML = (paymentType === 'card') ? 'Плащане с карта' : 'Наложен платеж';
        });
    }

    // Attach unified event handlers
    try {
        checkoutButton.addEventListener('click', function () {
            handleEcontPayment(checkoutButton, 'card');
        });
    } catch (error) {
        console.log(error)
    }
</script>
<script>
    // Helper to get CSRF token from cookies
    function getCookie(name) {
        let cookieValue = null
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';')
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim()
                if (cookie.startsWith(name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1))
                    break
                }
            }
        }
        return cookieValue
    }
    const csrftoken = getCookie('csrftoken')
    var codButton = document.getElementById('cod-payment');
    try {
        codButton.addEventListener('click', function () {
            handleEcontPayment(codButton, 'cash_on_delivery');
        });
    } catch (error) {
        console.log(error)
    }
</script>
<script>
    // Collapsible shipping block logic
    document.addEventListener('DOMContentLoaded', function() {
        var econtRadio = document.getElementById('shipping-econt');
        var speedyRadio = document.getElementById('shipping-speedy');
        var econtBlock = document.getElementById('econt-shipping-block');
        function updateShippingBlock() {
            if (econtRadio.checked) {
                econtBlock.classList.add('open');
            } else {
                econtBlock.classList.remove('open');
            }
        }
        if (econtRadio && speedyRadio && econtBlock) {
            econtRadio.addEventListener('change', updateShippingBlock);
            speedyRadio.addEventListener('change', updateShippingBlock);
            updateShippingBlock();
        }
    });
</script>
<script>
    // --- SHIPPING & PAYMENT METHOD LOGIC ---
    let selectedPayment = null;
    let selectedShipping = null;
    let lastEcontShipping = { shipping_price: null, shipping_price_cod: null, currency_sign: "лв." };

    function updateSummaryForPayment() {
        const shippingSummaryElem = document.getElementById('shipping-summary-value');
        const totalSummaryElem = document.getElementById('total-summary-value');
        let shipping = null;
        let showShipping = false;
        let shippingText = "-";
        let shippingVal = 0;

        let officeName = document.getElementById('econt_customer_office_name')?.value || '';

        if (selectedShipping === 'econt' && selectedPayment) {
            if (selectedPayment === 'cash_on_delivery') {
                if (lastEcontShipping.shipping_price_cod !== undefined && lastEcontShipping.shipping_price_cod !== null) {
                    shipping = lastEcontShipping.shipping_price_cod;
                    showShipping = true;
                    shippingText = shipping + ' ' + (lastEcontShipping.currency_sign || "лв.");
                    shippingVal = parseFloat(shipping);
                }
            } else if (selectedPayment === 'card') {
                if (lastEcontShipping.shipping_price_cod !== undefined && lastEcontShipping.shipping_price_cod !== null) {
                    shipping = (parseFloat(lastEcontShipping.shipping_price_cod) * 0.5).toFixed(2);
                    showShipping = true;
                    shippingText = shipping + ' ' + (lastEcontShipping.currency_sign || "лв.") + " (50% отстъпка)";
                    shippingVal = parseFloat(shipping);
                }
            }
        }

        // [Extend here for Speedy if needed]
        if (shippingSummaryElem) {
            if (showShipping) {
                shippingSummaryElem.textContent = shippingText;
            } else {
                shippingSummaryElem.textContent = '-';
            }
        }

        // Get backend-calculated total from the DOM
        let backendTotal = 0;
        const backendTotalElem = document.getElementById('backend-order-total');
        if (backendTotalElem) {
            backendTotal = parseFloat(backendTotalElem.dataset.value);
        }
        let total = backendTotal;

        // Free delivery only if order >= 75 and Econt office is selected
        let freeDeliveryThreshold = 75;
        if (backendTotal >= freeDeliveryThreshold && showShipping && officeName) {
            if (shippingSummaryElem) {
                shippingSummaryElem.textContent = "Безплатна доставка до офис";
            }
            if (totalSummaryElem) {
                totalSummaryElem.textContent = backendTotal.toFixed(2) + ' ' + (lastEcontShipping.currency_sign || "лв.");
            }
        } else {
            if (showShipping) {
                total = backendTotal + shippingVal;
            }
            if (shippingSummaryElem) {
                if (showShipping) {
                    shippingSummaryElem.textContent = shippingText;
                } else {
                    shippingSummaryElem.textContent = '-';
                }
            }
            if (totalSummaryElem) {
                if (total !== null && !isNaN(total)) {
                    totalSummaryElem.textContent = total.toFixed(2) + ' ' + (lastEcontShipping.currency_sign || "лв.");
                } else {
                    totalSummaryElem.textContent = '-';
                }
            }
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        const paymentCardRadio = document.getElementById('payment-card');
        const paymentCodRadio = document.getElementById('payment-cod');
        const continueBtn = document.getElementById('continue-payment');
        const shippingEcontRadio = document.getElementById('shipping-econt');
        const shippingSpeedyRadio = document.getElementById('shipping-speedy');
        const errorBlock = document.getElementById('checkout-error-block');

        // Ensure no payment method is preselected
        if (paymentCardRadio) paymentCardRadio.checked = false;
        if (paymentCodRadio) paymentCodRadio.checked = false;

        function updateShippingSelection() {
            selectedShipping = shippingEcontRadio.checked ? 'econt' :
                (shippingSpeedyRadio.checked ? 'speedy' : null);
            updateSummaryForPayment();
        }

        if (paymentCardRadio && paymentCodRadio) {
            paymentCardRadio.addEventListener('change', function() {
                selectedPayment = 'card';
                updateSummaryForPayment();
            });
            paymentCodRadio.addEventListener('change', function() {
                selectedPayment = 'cash_on_delivery';
                updateSummaryForPayment();
            });
        }
        if (shippingEcontRadio && shippingSpeedyRadio) {
            shippingEcontRadio.addEventListener('change', updateShippingSelection);
            shippingSpeedyRadio.addEventListener('change', updateShippingSelection);
        }
        // Set summary on load (no shipping/payment selected)
        updateSummaryForPayment();
    });

    // Econt iframe postMessage
    window.addEventListener('message', function(event) {
        var data = event.data;
        let shippingChanged = false;
        if (data && (data.shipping_price !== undefined || data.shipping_price_cod !== undefined)) {
            lastEcontShipping = {
                shipping_price: data.shipping_price,
                shipping_price_cod: data.shipping_price_cod,
                currency_sign: data.shipping_price_currency_sign || "лв."
            };
            shippingChanged = true;
        }
        if (data && data.id) {
            document.getElementById('econt_customer_name').value = data.name || '';
            document.getElementById('econt_customer_phone').value = data.phone || '';
            document.getElementById('econt_customer_email').value = data.email || '';
            document.getElementById('econt_customer_city').value = data.city_name || '';
            document.getElementById('econt_customer_address').value = data.address || '';
            document.getElementById('econt_customer_office_name').value = data.office_name || '';
            document.getElementById('econt_customer_office_code').value = data.office_code || '';
            document.getElementById('econt_customer_face').value = data.face || '';
            document.getElementById('econt_customer_post_code').value = data.post_code || '';
        }
        if (shippingChanged) {
            updateSummaryForPayment();
        }
    });

    // "Continue" button triggers hidden payment button
    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('continue-payment').addEventListener('click', function() {
            var errorBlock = document.getElementById('checkout-error-block');
            var paymentErrorBlock = document.getElementById('payment-error-block');
            var shippingErrorBlock = document.getElementById('shipping-error-block');
            if (errorBlock) errorBlock.innerHTML = '';
            if (paymentErrorBlock) paymentErrorBlock.innerHTML = '';
            if (shippingErrorBlock) shippingErrorBlock.innerHTML = '';
            // Determine which (if any) method is missing
            var missingPayment = !selectedPayment;
            var missingShipping = !selectedShipping;
            if (missingPayment || missingShipping) {
                if (missingPayment) {
                    if (paymentErrorBlock) {
                        paymentErrorBlock.innerHTML = '<div class="alert alert-danger mb-2">Моля, изберете метод на плащане!</div>';
                        paymentErrorBlock.scrollIntoView({ behavior: "smooth", block: "center" });
                    }
                } else if (missingShipping) {
                    if (shippingErrorBlock) {
                        shippingErrorBlock.innerHTML = '<div class="alert alert-danger mb-2">Моля, изберете метод на доставка!</div>';
                        shippingErrorBlock.scrollIntoView({ behavior: "smooth", block: "center" });
                    }
                }
                return;
            }
            if (selectedPayment === 'cash_on_delivery') {
                document.getElementById('cod-payment').click();
            } else if (selectedPayment === 'card') {
                document.getElementById('stripe-payment').click();
            }
        });
    });
</script>
<script>
    window.dataLayer = window.dataLayer || [];
    gtag('event', 'begin_checkout', {
    "items": [
        {% for item in order.order_items.all %}
        {
            "id": "{{ item.product.id }}",
            "name": "{{ item.product.name|escapejs }}",
            "category": "{{ item.product.category.title|escapejs }}",
            "price": {{ item.price|floatformat:2 }},
            "quantity": {{ item.qty }},
            "currency": "BGN"
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ],
    "value": {{ order.total|floatformat:2 }},
    "currency": "BGN"
    });
</script>
<script>
    if (typeof fbq === "function") {
    fbq('track', 'InitiateCheckout', {
        content_ids: [{% for item in order.order_items.all %}"{{ item.product.id }}"{% if not forloop.last %}, {% endif %}{% endfor %}],
        contents: [
        {% for item in order.order_items.all %}
            {
            id: "{{ item.product.id }}",
            quantity: {{ item.qty }}
            }{% if not forloop.last %},{% endif %}
        {% endfor %}
        ],
        value: {{ order.total|floatformat:2 }},
        currency: "BGN"
    });
    }
</script>
{% endblock %}